<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק אותיות וניקוד לכיתה א'</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Custom styles for the first-grade friendly app */
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f0fdf4; /* Light Green background */
        }
        .main-container {
            max-width: 900px;
        }
        .section-title {
            font-size: 1.75rem; /* 28px */
            font-weight: 900;
        }
        .button-primary {
            background-color: #10b981; /* Emerald 500 */
            transition: background-color 0.15s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #059669; /* Emerald 600 */
        }
        .game-option {
            font-size: 2.5rem;
            min-width: 150px;
            height: 150px;
            border-width: 4px;
            border-color: #facc15; /* Yellow 400 */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .game-option:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .checkbox-label {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #a7f3d0; /* Emerald 200 */
            transition: background-color 0.15s, border-color 0.15s;
            font-weight: 700;
        }
        input[type="checkbox"]:checked + .checkbox-label {
            background-color: #d1fae5; /* Emerald 100 */
            border-color: #10b981; /* Emerald 500 */
        }
        #message-box {
            min-height: 4rem;
        }
        .loading-ring {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Container -->
    <div class="main-container mx-auto p-4 bg-white shadow-2xl rounded-xl">
        <header class="text-center mb-8 border-b-4 border-yellow-400 pb-4">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-green-700">
                <i class="fas fa-hat-wizard text-yellow-500 ml-2"></i> לימוד הקריאה בכיתה א'
            </h1>
            <p class="text-xl text-gray-600 mt-2">משחק האות והניקוד: השמע ובחר נכון!</p>
        </header>

        <!-- Screens Container -->
        <div id="app-container">

            <!-- 1. Configuration Screen (תפריט סינון) -->
            <div id="config-screen" class="space-y-6">
                <h2 class="section-title text-green-600 border-b-2 pb-2">1. בחירת אותיות וניקוד למשחק</h2>

                <!-- Vowels Filter -->
                <div class="p-4 border-2 border-gray-100 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-700 mb-3">ניקודים לבחירה:</h3>
                    <div id="vowels-options" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <!-- Vowel checkboxes will be inserted here by JS -->
                    </div>
                </div>

                <!-- Consonants Filter -->
                <div class="p-4 border-2 border-gray-100 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-700 mb-3">אותיות לבחירה:</h3>
                    <div class="space-y-3">
                        <!-- General Letters -->
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <input type="checkbox" id="include-base" class="hidden" checked>
                            <label for="include-base" class="checkbox-label bg-emerald-100 border-emerald-500">אותיות בסיסיות (א, ב, ג...) <i class="fas fa-check-circle"></i></label>
                            <p class="text-sm text-gray-500 mr-4">חובה לכלול אותיות בסיס.</p>
                        </div>
                        <!-- Dagesh/Raphe -->
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <input type="checkbox" id="include-dagesh" class="hidden">
                            <label for="include-dagesh" class="checkbox-label">כולל אותיות עם / בלי דגש (ב / בּ, כ / כּ, פ / פּ)</label>
                        </div>
                        <!-- Final Letters -->
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <input type="checkbox" id="include-final" class="hidden">
                            <label for="include-final" class="checkbox-label">כולל אותיות סופיות (ך, ם, ן, ף, ץ)</label>
                        </div>
                    </div>
                </div>

                <!-- Start Button -->
                <div class="text-center pt-4">
                    <button id="start-game-btn" onclick="startGame()" class="button-primary text-white text-2xl py-4 px-8 rounded-full shadow-lg hover:shadow-xl transition duration-300 disabled:opacity-50" disabled>
                        <i class="fas fa-play ml-2"></i> התחל משחק
                    </button>
                    <p id="filter-error" class="text-red-500 mt-2 font-bold hidden">אנא בחר/י לפחות ניקוד אחד.</p>
                </div>
            </div>

            <!-- 2. Game Screen (ממשק המשחק) -->
            <div id="game-screen" class="hidden space-y-6 text-center">
                <h2 class="section-title text-green-600 border-b-2 pb-2">2. בחר/י את ההברה שהושמעה!</h2>

                <!-- Score and Back Button -->
                <div class="flex justify-between items-center text-lg font-bold">
                    <button onclick="backToConfig()" class="text-gray-500 hover:text-gray-700 text-base py-2 px-4 rounded-full bg-gray-100 transition">
                        <i class="fas fa-arrow-right ml-1"></i> חזור לסינון
                    </button>
                    <p class="text-xl text-blue-600">
                        ניקוד: <span id="correct-score">0</span> / <span id="total-score">0</span>
                    </p>
                </div>

                <!-- Play/Loading Area -->
                <div class="bg-yellow-50 p-6 rounded-xl shadow-inner border-4 border-yellow-300">
                    <button id="play-sound-btn" onclick="playCurrentSyllable()" class="bg-red-500 text-white text-3xl p-6 rounded-full shadow-xl hover:bg-red-600 transition duration-300 disabled:opacity-50">
                        <i id="play-icon" class="fas fa-volume-up"></i>
                        <span id="loading-spinner" class="hidden loading-ring inline-block"></span>
                        <span class="mr-2">השמע שוב</span>
                    </button>

                    <div id="message-box" class="mt-4 font-bold text-2xl text-gray-700 min-h-[50px] flex items-center justify-center">
                        טוען נתוני אודיו...
                    </div>
                </div>

                <!-- Options Grid -->
                <div id="options-grid" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                    <!-- Option buttons will be inserted here by JS -->
                </div>

            </div>

        </div>
    </div>

    <!-- Game Logic and Audio Loader -->
    <script>
        // Make functions and variables available globally
        window.startGame = startGame;
        window.playCurrentSyllable = playCurrentSyllable;
        window.checkAnswer = checkAnswer;
        window.backToConfig = backToConfig;

        // Vowel and letter data
        const VOWELS = [
            { char: '\u05B8', name: 'קמץ (a)' }, // Kamatz
            { char: '\u05B7', name: 'פתח (a)' }, // Patach
            { char: '\u05B6', name: 'סגול (e)' }, // Segol
            { char: '\u05B5', name: 'צירה (e)' }, // Tzere
            { char: '\u05B4', name: 'חיריק (i)' }, // Chirik
            { char: '\u05B9', name: 'חולם חסר (o)' }, // Holam (Chaser)
            { char: 'ו\u05B9', name: 'חולם מלא (o)' }, // Holam (Maleh)
            { char: '\u05BB', name: 'קובוץ (u)' }, // Kubutz
            { char: 'וּ', name: 'שורוק (u)' }, // Shuruk (Vav + Dagesh/Shuruk)
        ];
        // Letters are split for filtering logic
        const BASE_LETTERS = ['א', 'ג', 'ד', 'ה', 'ו', 'ז', 'ח', 'ט', 'י', 'ל', 'מ', 'נ', 'ס', 'ע', 'צ', 'ק', 'ר', 'ש', 'ת'];
        const DAGESH_LETTERS = ['ב', 'בּ', 'כ', 'כּ', 'פ', 'פּ']; // Raphe and Dagesh
        const FINAL_LETTERS = ['ך', 'ם', 'ן', 'ף', 'ץ'];

        let allowedSyllables = [];
        let currentSyllable = '';
        let correctScore = 0;
        let totalScore = 0;
        let isAudioPlaying = false;
        const NUM_OPTIONS = 4;
        
        // Audio Manifest will be loaded here from audio_manifest.js
        let audioManifest = {}; 

        // UI elements
        const configScreen = document.getElementById('config-screen');
        const gameScreen = document.getElementById('game-screen');
        const vowelsOptionsDiv = document.getElementById('vowels-options');
        const startGameBtn = document.getElementById('start-game-btn');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const optionsGrid = document.getElementById('options-grid');
        const messageBox = document.getElementById('message-box');
        const correctScoreSpan = document.getElementById('correct-score');
        const totalScoreSpan = document.getElementById('total-score');
        const playIcon = document.getElementById('play-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const filterError = document.getElementById('filter-error');
        
        /**
         * Loads the external AudioManifest file (audio_manifest.js).
         */
        async function loadManifest() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'audio_manifest.js';
                document.head.appendChild(script);

                script.onload = () => {
                    // Assuming the manifest defines a global variable named 'AudioManifest'
                    if (typeof window.AudioManifest !== 'undefined') {
                        audioManifest = window.AudioManifest;
                        console.log("Audio Manifest loaded successfully.");
                        resolve();
                    } else {
                        reject(new Error("AudioManifest variable not found after loading script."));
                    }
                };
                script.onerror = () => reject(new Error("Failed to load audio_manifest.js."));
            });
        }

        /**
         * Plays the local audio file for the given syllable using the manifest.
         * The files are assumed to be in the /audio/ directory.
         * @param {string} syllable The Hebrew syllable.
         */
        function playLocalAudio(syllable) {
            const filename = audioManifest[syllable];
            if (!filename) {
                console.error(`Filename not found for syllable: ${syllable}`);
                messageBox.textContent = `שגיאה: אין קובץ צליל עבור '${syllable}'.`;
                setLoading(false);
                return;
            }

            try {
                // Audio files are expected to be in a subdirectory named 'audio'
                const audioUrl = `./audio/${filename}`;
                const audio = new Audio(audioUrl);
                
                audio.onplaying = () => {
                    isAudioPlaying = true;
                    // Disable all buttons while playing
                    document.querySelectorAll('#options-grid button').forEach(btn => btn.disabled = true);
                    playSoundBtn.disabled = true;
                    setLoading(false);
                };
                audio.onended = () => {
                    isAudioPlaying = false;
                    // Re-enable options
                    document.querySelectorAll('#options-grid button').forEach(btn => btn.disabled = false);
                    playSoundBtn.disabled = false;
                };
                
                // Handle audio not found or error loading (e.g., 404)
                audio.onerror = (e) => {
                    console.error(`Error loading or playing audio file: ${audioUrl}`, e);
                    messageBox.textContent = "שגיאה בטעינת קובץ האודיו. ודא שכל הקבצים נמצאים בתיקיית /audio.";
                    setLoading(false);
                };

                audio.play();

            } catch (e) {
                console.error("Audio playback error:", e);
                messageBox.textContent = "שגיאה בניגון הצליל.";
                setLoading(false);
            }
        }

        /**
         * Sets the loading state for the play button.
         * @param {boolean} isLoading
         */
        function setLoading(isLoading) {
            if (isLoading) {
                playIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                playSoundBtn.disabled = true;
                optionsGrid.querySelectorAll('button').forEach(btn => btn.disabled = true);
            } else {
                playIcon.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                if (!isAudioPlaying) {
                    playSoundBtn.disabled = false;
                    // Only re-enable options if we are on the game screen
                    if (!gameScreen.classList.contains('hidden')) {
                         optionsGrid.querySelectorAll('button').forEach(btn => btn.disabled = false);
                    }
                }
            }
        }

        /**
         * Plays the current syllable audio.
         */
        function playCurrentSyllable() {
            if (!currentSyllable || isAudioPlaying) return;

            // Simulate loading, though local files load fast
            setLoading(true);
            messageBox.textContent = "מנגן צליל...";

            playLocalAudio(currentSyllable);
            messageBox.textContent = "לחץ/י על התשובה הנכונה:";
        }

        /**
         * Generates the set of allowed syllables based on user filters.
         */
        function updateAllowedSyllables() {
            const selectedVowels = Array.from(document.querySelectorAll('#vowels-options input:checked')).map(cb => cb.value);
            const includeDagesh = document.getElementById('include-dagesh').checked;
            const includeFinal = document.getElementById('include-final').checked;
            const includeBase = document.getElementById('include-base').checked;

            if (selectedVowels.length === 0) {
                startGameBtn.disabled = true;
                filterError.classList.remove('hidden');
                allowedSyllables = [];
                return;
            }

            filterError.classList.add('hidden');
            let potentialSyllables = [];

            // 1. Build the list of allowed consonants
            let allowedConsonants = [];
            if (includeBase) {
                allowedConsonants.push(...BASE_LETTERS);
            }
            if (includeDagesh) {
                allowedConsonants.push(...DAGESH_LETTERS);
            } else {
                allowedConsonants.push('ב', 'כ', 'פ');
                allowedConsonants = allowedConsonants.filter(c => c !== 'בּ' && c !== 'כּ' && c !== 'פּ');
            }
            if (includeFinal) {
                allowedConsonants.push(...FINAL_LETTERS);
            }
            allowedConsonants = [...new Set(allowedConsonants)];

            // 2. Combine consonants and vowels
            for (const consonant of allowedConsonants) {
                for (const vowel of selectedVowels) {
                    if (consonant === 'ו' && (vowel === 'וּ' || vowel === 'ו\u05B9' )) {
                        potentialSyllables.push(vowel);
                    } else if (consonant === 'ו') {
                        continue;
                    }
                    else if (vowel === 'וּ' || vowel === 'ו\u05B9') {
                        continue;
                    }
                     else {
                         potentialSyllables.push(consonant + vowel);
                    }
                }
            }
            if (selectedVowels.includes('ו\u05B9')) {
                potentialSyllables.push('ו\u05B9');
            }
            if (selectedVowels.includes('וּ')) {
                potentialSyllables.push('וּ');
            }

            // 3. Filter syllables to only include those available in the manifest
            allowedSyllables = [...new Set(potentialSyllables)]
                .filter(s => s)
                .filter(s => audioManifest.hasOwnProperty(s));
            
            // Re-check if we have any valid syllables left
            if (allowedSyllables.length === 0) {
                 startGameBtn.disabled = true;
                 messageBox.textContent = "אין הברות תואמות עם ניקודים וקבצי אודיו זמינים.";
                 filterError.classList.remove('hidden');
            } else {
                startGameBtn.disabled = false;
                messageBox.textContent = "לחץ/י על 'התחל משחק'!";
            }
            console.log("Allowed Syllables (Filtered by Manifest):", allowedSyllables);
        }

        /**
         * Initializes the game state and UI for a new round.
         */
        function nextRound() {
            if (allowedSyllables.length === 0) {
                messageBox.textContent = "שגיאה: אין הברות נבחרות.";
                return;
            }

            let options = new Set();
            
            // Start by grabbing 4 random, unique syllables from the allowed list
            while (options.size < NUM_OPTIONS) {
                const randomIndex = Math.floor(Math.random() * allowedSyllables.length);
                const randomSyllable = allowedSyllables[randomIndex];
                options.add(randomSyllable);
            }
            
            options = Array.from(options).sort(() => Math.random() - 0.5);

            const correctIndex = Math.floor(Math.random() * options.length);
            currentSyllable = options[correctIndex];
            
            optionsGrid.innerHTML = '';
            options.forEach(syllable => {
                const btn = document.createElement('button');
                btn.textContent = syllable;
                btn.className = 'game-option flex items-center justify-center bg-white text-gray-800 rounded-xl shadow-md border-b-8 hover:bg-yellow-100 disabled:opacity-50';
                btn.onclick = () => checkAnswer(syllable);
                btn.disabled = true; // Disable until audio is played
                optionsGrid.appendChild(btn);
            });

            messageBox.textContent = "לחץ/י על הרמקול כדי לשמוע את ההברה";
            playSoundBtn.disabled = false;
        }

        /**
         * Checks the user's selected answer.
         * @param {string} chosenSyllable The syllable the user clicked.
         */
        function checkAnswer(chosenSyllable) {
            optionsGrid.querySelectorAll('button').forEach(btn => btn.disabled = true);
            playSoundBtn.disabled = true;

            totalScore++;
            let isCorrect = false;

            if (chosenSyllable === currentSyllable) {
                correctScore++;
                messageBox.innerHTML = '<span class="text-green-600">כל הכבוד! נכון! <i class="fas fa-check-circle"></i></span>';
                isCorrect = true;
            } else {
                messageBox.innerHTML = `<span class="text-red-600">אופס! טעות. <i class="fas fa-times-circle"></i></span><br>התשובה הנכונה: <span class="text-3xl font-extrabold text-blue-600">${currentSyllable}</span>`;
                isCorrect = false;
            }

            optionsGrid.querySelectorAll('button').forEach(btn => {
                if (btn.textContent === currentSyllable) {
                    btn.classList.add('bg-green-300', 'border-green-600');
                    btn.classList.remove('bg-white', 'border-yellow-400', 'hover:bg-yellow-100');
                } else if (btn.textContent === chosenSyllable && !isCorrect) {
                    btn.classList.add('bg-red-300', 'border-red-600');
                    btn.classList.remove('bg-white', 'border-yellow-400', 'hover:bg-yellow-100');
                }
            });

            correctScoreSpan.textContent = correctScore;
            totalScoreSpan.textContent = totalScore;

            setTimeout(nextRound, 2500);
        }

        /**
         * Initializes the Vowels filter UI.
         */
        function initializeVowelsUI() {
            VOWELS.forEach(vowel => {
                const container = document.createElement('div');
                container.className = 'flex items-center space-x-2 space-x-reverse';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `vowel-${vowel.char.replace(/[^\w]/g, '_')}`;
                input.value = vowel.char;
                input.className = 'hidden';
                input.checked = true; // Default: All checked
                input.onchange = updateAllowedSyllables;

                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.className = 'checkbox-label text-xl flex items-center justify-center w-full';
                label.innerHTML = `${vowel.char} <span class="text-sm mr-2 text-gray-500">(${vowel.name})</span>`;

                container.appendChild(input);
                container.appendChild(label);
                vowelsOptionsDiv.appendChild(container);
            });

            document.getElementById('include-dagesh').onchange = updateAllowedSyllables;
            document.getElementById('include-final').onchange = updateAllowedSyllables;

            // No initial updateAllowedSyllables here; it runs after manifest load.
        }

        /**
         * Toggles the view to the game screen and starts the first round.
         */
        function startGame() {
            if (allowedSyllables.length === 0) {
                filterError.classList.remove('hidden');
                return;
            }
            configScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            messageBox.textContent = "מתחילים! לחץ/י על הרמקול";
            correctScore = 0;
            totalScore = 0;
            correctScoreSpan.textContent = 0;
            totalScoreSpan.textContent = 0;
            nextRound();
        }

        /**
         * Toggles the view back to the configuration screen.
         */
        function backToConfig() {
            gameScreen.classList.add('hidden');
            configScreen.classList.remove('hidden');
            updateAllowedSyllables(); // Re-check validity
        }

        // Run initialization on load
        window.onload = async () => {
            initializeVowelsUI();
            try {
                 await loadManifest();
                 updateAllowedSyllables(); // Update filters once manifest is ready
            } catch (e) {
                console.error(e);
                messageBox.textContent = e.message;
                startGameBtn.disabled = true;
            }
        };

    </script>
    <!-- The audio manifest is assumed to be loaded here -->
    <script src="audio_manifest.js"></script>
</body>
</html>
